# ميزة تعليق الطلبات - Order Suspension Feature

## نظرة عامة
تم إضافة ميزة تعليق الطلبات التي تسمح للدليفري بتعليق الطلب في حالة عدم تمكنه من الوصول للعميل، مع إظهار هذه الطلبات في لوحة تحكم السوبر أدمن.

## التغييرات المطلوبة

### 1. Backend Changes

#### أ. إضافة هجرة قاعدة البيانات
- **ملف:** `backend/database/migrations/2025_01_12_000001_add_suspended_status_to_orders.php`
- **التغييرات:**
  - إضافة حالة `suspended` إلى enum الخاص بجدول `orders`
  - إضافة حالة `suspended` إلى enum الخاص بجدول `order_history`
  - إضافة عمود `suspended_at` (timestamp)
  - إضافة عمود `suspension_reason` (text)

#### ب. تحديث نموذج Order
- **ملف:** `backend/app/Models/Order.php`
- **التغييرات:**
  - إضافة `suspended_at` و `suspension_reason` إلى `fillable`
  - إضافة `suspended_at` إلى `dates`
  - إضافة دالة `isSuspended()`
  - إضافة دالة `canBeSuspended()`
  - إضافة دالة `suspend($deliveryPersonId, $reason)`
  - إضافة حالة "معلق" في `getStatusLabel()`
  - إضافة وصف في `getNextAction()`

#### ج. تحديث DeliveryController
- **ملف:** `backend/app/Http/Controllers/Api/DeliveryController.php`
- **التغييرات:**
  - إضافة دالة `suspendOrder(Request $request, $orderId)`
  - إضافة دالة `suspendedOrders()` لجلب الطلبات المعلقة
  - تحديث `myOrders()` لاستبعاد الطلبات المعلقة

#### د. تحديث المسارات
- **ملف:** `backend/routes/api.php`
- **التغييرات:**
  - إضافة route: `POST /delivery/orders/{id}/suspend`
  - إضافة route: `GET /delivery/suspended-orders`

### 2. Frontend Changes

#### أ. تحديث API
- **ملف:** `src/lib/api.js`
- **التغييرات:**
  - إضافة دالة `suspendOrder(orderId, data)`
  - إضافة دالة `suspendedOrders()`

#### ب. تحديث صفحة التسليم للدليفري
- **ملف:** `src/pages/DeliveryDeliverPage.jsx`
- **التغييرات:**
  - إضافة state: `isSuspending`, `suspensionReason`
  - إضافة دالة `handleSuspendOrder()`
  - إضافة قسم "تعليق الطلب" مع Textarea لإدخال السبب
  - إضافة زر "تعليق الطلب" مع أيقونة `PauseCircle`
  - إضافة import للـ `Textarea` و `PauseCircle`

#### ج. تحديث داشبورد الدليفري
- **ملف:** `src/pages/DeliveryDashboardPage.jsx`
- **التغييرات:**
  - إضافة state: `suspendedOrders`
  - إضافة دالة `fetchSuspendedOrders()`
  - إضافة دالة `refreshAllData()`
  - إضافة تبويب "طلبات معلقة" في Tabs
  - إضافة كارد إحصائي للطلبات المعلقة
  - إضافة دالة `renderSuspendedOrderCard()`
  - تحديث Grid الإحصائيات ليكون 4 أعمدة
  - إضافة import للـ `PauseCircle`

#### د. تحديث لوحة تحكم الأدمن
- **ملف:** `src/components/admin/AdminOrders.jsx`
- **التغييرات:**
  - إضافة حالة "معلق" في `statusMap`
  - إضافة خيار "معلق" في فلتر الحالات
  - إضافة كارد إحصائي للطلبات المعلقة
  - تحديث Grid الإحصائيات ليكون 5 أعمدة
  - إضافة قسم "معلومات التعليق" في تفاصيل الطلب
  - إضافة مؤشر بصري للطلبات المعلقة في الكارد
  - إضافة معلومات التعليق في عرض الكارد

## الميزات الجديدة

### 1. للدليفري
- **زر تعليق الطلب:** في صفحة التسليم مع إمكانية إدخال سبب التعليق
- **تبويب الطلبات المعلقة:** في الداشبورد لعرض جميع الطلبات المعلقة
- **إحصائيات:** عداد للطلبات المعلقة في الداشبورد

### 2. للسوبر أدمن
- **فلترة بحالة معلق:** إمكانية فلترة الطلبات المعلقة
- **إحصائيات:** عداد للطلبات المعلقة
- **تفاصيل التعليق:** عرض سبب التعليق وتاريخه في تفاصيل الطلب
- **مؤشر بصري:** تمييز الطلبات المعلقة بإطار أصفر وعلامة "معلق"

## كيفية الاستخدام

### 1. الدليفري
1. عند محاولة تسليم طلب والوصول لصفحة التسليم
2. في حالة عدم إمكانية الوصول للعميل، يختار "تعليق الطلب"
3. يكتب سبب التعليق (مثل: لم يرد العميل، عنوان خاطئ، إلخ)
4. يضغط على زر "تعليق الطلب"
5. يتم تحويل حالة الطلب إلى "معلق" وإزالته من قائمة مهام الدليفري

### 2. السوبر أدمن
1. يمكن رؤية الطلبات المعلقة في قائمة الطلبات مع تمييز بصري
2. يمكن فلترة الطلبات لعرض المعلقة فقط
3. يمكن رؤية تفاصيل التعليق وسببه عند فتح تفاصيل الطلب
4. يمكن متابعة الإحصائيات من خلال الكارد المخصص

## تشغيل الهجرة
```bash
cd backend
php artisan migrate
```

## ملاحظات تقنية
- الطلبات المعلقة لا تظهر في قائمة مهام الدليفري
- يمكن تعليق الطلب فقط عندما يكون في حالة "قيد التوصيل"
- جميع عمليات التعليق تُسجل في تاريخ الطلب (order_history)
- التصميم متجاوب ويدعم اللغة العربية والـ RTL
